# 高可用性構成

## 10-1 ロードバランサー

ELB Elastic Load Balancer が提供されている

以下の3種類ある

* CLB (Classic Load Balancer)
* ALB (Application Load Balancer)
* NLB (Network Load Balancer)

### ELB

* フルマネージド
* ヘルスチェック
* 高可用性
* スケーラブル
* 他サイト連動

構成例

ELBをVPC内で利用

ELB配下にEC2とRDSをアベイラビリティゾーンを分散して配置

基本はAZをわけるのがよいがレイテンシがシビアなどの条件がある場合は1つのアベイラビリティゾーンによせる

DNSはELBが発行するドメイン名を指定する

スケールイン、アウトで動的にIPが変わるため

### Internet Facing/Internal

ELBはInternalでも利用可能

### SSL Termination

ELB側でHTTPSを受信して内部ではHTTPで通信する

負荷軽減になる

OpenSSLの脆弱性対応をAWSに投げられる

### スティッキーセッション

セッション維持している時同じEC2に送信する

オートスケールなどでEC2が変動したときはセッションが切れる

### CLB

レガシー

HTTP/HTTPS/TCP/SSL対応

### ALB

レイヤー７対応

* コンテントベースルーティング
  * URLパスでルーティングする
* 動的ポートマッピング
* WebSockets HTTP/2対応

### NLB

TCPの負荷分散に特化

CLB,ALBは突発的なアクセス増加に対応するためにAWSに暖気申請の必要があるがNLBは不要

CLB,ALBは通常のスケールイン、アウトに対応できない場合がある

高スループット,低レイテンシー

SSL Termination機能はない

ターゲットにEC2インスタンではなくIPを指定、オンプレにも対応

固定グローバルIP付与可能

SourceIP/Portがターゲットまで保持する

対応プロトコルはTCPのみ

## 10-2 オートスケール

### オートスケール

需要に応じてEC2インスタンスを自動で拡張、縮小する

### スケーリングプラン

* 動的スケーリング
  * CloudWatchのメトリクスに応じてインスタンスの追加削除を行う
    * スケーリングポリシーで定義する
      * シンプリスケーリングポリシー
        * CPU使用率80%で2台追加
      * ステップスケーリングポリシー
        * CPU60%で2台、80%でもう2台
      * ターゲット追跡スケーリングポリシー
        * 平均CPU使用率50%を目指す

* スケジュールベーススケーリング
  * 予め時間帯を定めて台数を決める

組み合わせることも可能

### 最低台数と最大台数

スケーリングは最低、最大をきめることができる

### ヘルスチェック

* EC2ヘルスチェック
  * インスタンス自身が起動しているか確認
  * アプリが起動しているとは限らない
* ELBヘルスチェック
  * アプリケーションもチェック

### インスタンスの初期化処理

* ゴールデンイメージ
  * 起動早い
  * イメージの定義が必要
* ユーザデータ
  * 変更に手間がかからない
  * アプリ配布に時間がかかる

### ステートレスな実装

インスタンスには状態を持たせないこと

消えて困るデータはDB、S3などに保存する

### 予期できない急激なアクセス増の対応

EC2インスタンスは起動に時間がかかるので突発的なアクセス増には向いていない

CloudFrontなどを活用してEC2以外に負荷を逃がす

## 10-3 オートスケーリングによる耐障害性設計

### 耐障害性の向上

EC2をAZに分散する

## 10-4 オートスケールとインスタンス購入オプションによるコスト最適化

リザーブドインスタンスやスポットインスタンスと組み合わせる

### リザーブドインスタンスと組合せた構成

最低台数はリザーブドインスタンス、追加分はオンデマンドインスタンス

### スポットインスタンスと組合せた構成

オートスケール分をすべてスポットインスタンスにすると停止してしまう恐れがある

最低台数をオンデマンド、追加分をスポットにする

## 10-5 Queueによる負荷分散と動的スケーリング

### Workerの動的スケーリング

SQSのメッセージ数に応じてEC2を動的にスケールすることも可能

## 10-6 データベースキャッシュによる負荷分散と高パフォーマンス

### ElastitCache

データをキャッシュして低レイテンシーでデータを配信する

### ElastitCacheによる負荷分散

DBのクエリ結果をキャッシュ

## 10-7 データベースの高可用性

### RDSのMulti-AZ

RDSではオプションで指定可能

### フルマネージドデータベース

AWSが可用性を担保している

ヘルスチェックで異常が出たら自動で削除される